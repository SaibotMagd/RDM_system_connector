

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.io_functions &mdash; RDM_system_connector documentation 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            RDM_system_connector documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">RDM_system_connector</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">RDM_system_connector documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.io_functions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.io_functions</h1><div class="highlight"><pre>
<span></span><span class="c1"># Standard library imports</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="c1"># Third-party library imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># OMERO imports</span>
<span class="kn">import</span> <span class="nn">omero.clients</span>
<span class="kn">from</span> <span class="nn">omero.gateway</span> <span class="kn">import</span> <span class="n">BlitzGateway</span><span class="p">,</span> <span class="n">ProjectWrapper</span><span class="p">,</span> <span class="n">DatasetWrapper</span><span class="p">,</span> <span class="n">ImageWrapper</span>
<span class="kn">from</span> <span class="nn">omero.model</span> <span class="kn">import</span> <span class="n">OriginalFileI</span><span class="p">,</span> <span class="n">ProjectAnnotationLinkI</span>
<span class="c1"># import omero</span>

<span class="c1"># Local imports</span>
<span class="kn">from</span> <span class="nn">src.io_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">data</span> <span class="kn">import</span> <span class="o">*</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>

<div class="viewcode-block" id="create_bulk_import_file">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_bulk_import_file">[docs]</a>
<span class="k">def</span> <span class="nf">create_bulk_import_file</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">docker_vol_path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;./data/image_import_files.csv&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a bulk import file for OMERO.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    id (str): The ID of the dataset.</span>
<span class="sd">    path (str): The path to the image file.</span>
<span class="sd">    docker_vol_path (str): The path to the Docker volume.</span>
<span class="sd">    filename (str): The name of the bulk import file. Default is &#39;./data/image_import_files.csv&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    int: 0 if the operation is successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docker_vol_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;Dataset:</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">])</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="get_file_list">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_file_list">[docs]</a>
<span class="k">def</span> <span class="nf">get_file_list</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Traverse the specified directory and its subdirectories to collect all the file paths.</span>

<span class="sd">    :param folder: The path of the directory to traverse.</span>
<span class="sd">    :return: A list of all the file paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">file_list</span></div>



<div class="viewcode-block" id="get_netstore_filelist">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_netstore_filelist">[docs]</a>
<span class="k">def</span> <span class="nf">get_netstore_filelist</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;/home/omero-import&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Organize the file paths into a dictionary based on the project names found in the file paths.</span>

<span class="sd">    :param folder: The path of the directory to traverse.</span>
<span class="sd">    :return: A tuple containing a list of project names and a dictionary where each key is a project name and the value is a list of file paths belonging to that project.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the list of all file paths</span>
    <span class="n">filelist</span> <span class="o">=</span> <span class="n">get_file_list</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># Print the first 5 file paths for verification</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 5 files: &quot;</span><span class="p">,</span> <span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>

    <span class="c1"># Extract the project names from the file paths</span>
    <span class="n">cutfilelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">):]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 5 base folders: &quot;</span><span class="p">,</span> <span class="n">cutfilelist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">projectlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cutfilelist</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 5 projects: &quot;</span><span class="p">,</span> <span class="n">projectlist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>

    <span class="c1"># Organize the file paths into a dictionary based on the project names</span>
    <span class="n">fileDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">projectlist</span><span class="p">:</span>
        <span class="n">fileDict</span><span class="p">[</span><span class="n">project</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filelist</span> <span class="k">if</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="c1"># Print the project names for verification</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Projects: &quot;</span><span class="p">,</span> <span class="n">fileDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">projectlist</span><span class="p">,</span> <span class="n">fileDict</span></div>



<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">json</span>

<div class="viewcode-block" id="get_remaining_path">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_remaining_path">[docs]</a>
<span class="k">def</span> <span class="nf">get_remaining_path</span><span class="p">(</span><span class="n">full_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a full path and a base path as input and returns the remaining path.</span>
<span class="sd">    If the full path starts with the base path, it removes the base path from the full path and returns the remaining path.</span>
<span class="sd">    If the full path does not start with the base path, it returns the full path as is.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    full_path (str): The full path.</span>
<span class="sd">    base_path (str): The base path.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The remaining path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">full_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">full_path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">base_path</span><span class="p">):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">full_path</span></div>


<div class="viewcode-block" id="copy_author_from_projectcolumn">
<a class="viewcode-back" href="../../src.html#src.io_functions.copy_author_from_projectcolumn">[docs]</a>
<span class="k">def</span> <span class="nf">copy_author_from_projectcolumn</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a DataFrame as input and copies the author information from the project column to the author column.</span>
<span class="sd">    The author information is expected to be present in the project column in the format &quot;Project Name (Author Name)&quot;.</span>
<span class="sd">    The function extracts the author name from the project column and appends it to the author column.</span>
<span class="sd">    If the author column already contains some information, the new author name is appended to it.</span>
<span class="sd">    The function also removes any duplicates from the author column and returns the updated DataFrame.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df (pd.DataFrame): The input DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: The updated DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">)])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="load_json_file">
<a class="viewcode-back" href="../../src.html#src.io_functions.load_json_file">[docs]</a>
<span class="k">def</span> <span class="nf">load_json_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a file path as input and loads the JSON file at that path.</span>
<span class="sd">    It returns the JSON data as a dictionary.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    file_path (str): The path to the JSON file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: The JSON data as a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_abbreviation_dict">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_abbreviation_dict">[docs]</a>
<span class="k">def</span> <span class="nf">get_abbreviation_dict</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function loads the abbreviations JSON file and returns the data as a dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: The abbreviations data as a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load_json_file</span><span class="p">(</span><span class="s2">&quot;./abbreviations.json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_description_dict">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_description_dict">[docs]</a>
<span class="k">def</span> <span class="nf">get_description_dict</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function loads the descriptions JSON file and returns the data as a dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: The descriptions data as a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load_json_file</span><span class="p">(</span><span class="s2">&quot;../descriptions.json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_create_table_sql">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_create_table_sql">[docs]</a>
<span class="k">def</span> <span class="nf">get_create_table_sql</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function loads the database create SQL JSON file and returns the data as a dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: The database create SQL data as a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load_json_file</span><span class="p">(</span><span class="s2">&quot;./db_create_sql.json&quot;</span><span class="p">)</span></div>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<div class="viewcode-block" id="check_db_table">
<a class="viewcode-back" href="../../src.html#src.io_functions.check_db_table">[docs]</a>
<span class="k">def</span> <span class="nf">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks if a table exists in a SQLite database.</span>
<span class="sd">    If the table does not exist, it creates the table using the SQL code from the get_create_table_sql() function.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    table_name (str): The name of the table to check.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Check if table exists</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39; AND name=&#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">table_exists</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_exists</span><span class="p">:</span>
        <span class="n">sql_create_code</span> <span class="o">=</span> <span class="n">get_create_table_sql</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="n">sql_create_code</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_create_code</span><span class="p">[</span><span class="n">sql</span><span class="p">])</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="insert_dict_to_database">
<a class="viewcode-back" href="../../src.html#src.io_functions.insert_dict_to_database">[docs]</a>
<span class="k">def</span> <span class="nf">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function inserts a dictionary of data into a SQLite database table.</span>
<span class="sd">    It takes the database name, table name, and a dictionary of data as input.</span>
<span class="sd">    The keys of the dictionary are used as column names and the values are used as the corresponding row values.</span>
<span class="sd">    If an IntegrityError is raised, the function commits the changes and closes the connection.</span>
<span class="sd">    The function returns 1 if an IntegrityError is raised and 0 otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    table_name (str): The name of the table to insert data into.</span>
<span class="sd">    data_dict (Dict[str, any]): A dictionary of data to insert into the table.</span>

<span class="sd">    Returns:</span>
<span class="sd">    int: 1 if an IntegrityError is raised, 0 otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">placeholders</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;?&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">])</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s2">) VALUES (</span><span class="si">{</span><span class="n">placeholders</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="c1"># Connect to the database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="get_project_user_tuple">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_project_user_tuple">[docs]</a>
<span class="k">def</span> <span class="nf">get_project_user_tuple</span><span class="p">(</span><span class="n">pm_title</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a project title as input and extracts the project name and user information from it.</span>
<span class="sd">    The project name is expected to be present before the opening parenthesis in the project title.</span>
<span class="sd">    The user information is expected to be present between the opening and closing parentheses in the project title.</span>
<span class="sd">    The function returns a tuple containing the project name and user information.</span>
<span class="sd">    If there is no user information present in the project title, the function returns the project name and an empty string.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    pm_title (str): The project title.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Tuple[str, str]: A tuple containing the project name and user information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check if there&#39;s even an author in the project name</span>
    <span class="k">if</span> <span class="n">pm_title</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pm_title</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># Extract the name and user information from the pm_title string</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">user_info</span> <span class="o">=</span> <span class="n">pm_title</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># Remove the closing parenthesis and split the user information into a list</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="c1"># Remove any leading or trailing whitespace from each user in the list</span>
    <span class="n">user</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">user</span><span class="p">]</span>
    <span class="c1"># Join the users back into a single string, separated by semicolons</span>
    <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">user</span></div>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<div class="viewcode-block" id="get_df_if_exist">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_df_if_exist">[docs]</a>
<span class="k">def</span> <span class="nf">get_df_if_exist</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a file path as input and checks if a file exists at that path.</span>
<span class="sd">    If the file exists, it loads the file into a DataFrame and returns the DataFrame.</span>
<span class="sd">    If the file does not exist, it returns None.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    file_path (str): The path to the file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: The DataFrame if the file exists, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the file exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="c1"># If the file exists, load it into a DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="save_df">
<a class="viewcode-back" href="../../src.html#src.io_functions.save_df">[docs]</a>
<span class="k">def</span> <span class="nf">save_df</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a file path and a DataFrame as input and saves the DataFrame to a CSV file at the specified path.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    file_path (str): The path to the file.</span>
<span class="sd">    df (pd.DataFrame): The DataFrame to save.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_int_timestamp_from_iso">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_int_timestamp_from_iso">[docs]</a>
<span class="k">def</span> <span class="nf">get_int_timestamp_from_iso</span><span class="p">(</span><span class="n">iso_timestamp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes an ISO timestamp as input and converts it to an integer timestamp.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    iso_timestamp (str): The ISO timestamp.</span>

<span class="sd">    Returns:</span>
<span class="sd">    int: The integer timestamp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iso_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span>
        <span class="n">iso_timestamp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
    <span class="n">iso_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iso_timestamp</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">iso_timestamp</span></div>


<div class="viewcode-block" id="get_iso_timestamp_from_int">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_iso_timestamp_from_int">[docs]</a>
<span class="k">def</span> <span class="nf">get_iso_timestamp_from_int</span><span class="p">(</span><span class="n">int_timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes an integer timestamp as input and converts it to an ISO timestamp.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    int_timestamp (int): The integer timestamp.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The ISO timestamp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iso_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">int_timestamp</span><span class="p">)</span>
    <span class="n">iso_timestamp</span> <span class="o">=</span> <span class="n">iso_timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">iso_timestamp</span></div>


<div class="viewcode-block" id="check_if_entry_exists">
<a class="viewcode-back" href="../../src.html#src.io_functions.check_if_entry_exists">[docs]</a>
<span class="k">def</span> <span class="nf">check_if_entry_exists</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_document</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks if a specific entry exists in a SQLite database table.</span>
<span class="sd">    It takes the database name, table name, and a dictionary containing the specific ID as input.</span>
<span class="sd">    The function returns 1 if the entry exists and 0 otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    table_name (str): The name of the table to check.</span>
<span class="sd">    object_document (Dict[str, any]): A dictionary containing the specific ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">    int: 1 if the entry exists, 0 otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Connect to the database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># SQL command to check for the specific value</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT EXISTS (SELECT 1 FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> WHERE specific_id = ?);&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">object_document</span><span class="p">[</span><span class="s1">&#39;specific_id&#39;</span><span class="p">],)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An error occurred:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="get_cleaned_tag_string">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_cleaned_tag_string">[docs]</a>
<span class="k">def</span> <span class="nf">get_cleaned_tag_string</span><span class="p">(</span><span class="n">input_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a string as input and cleans it by replacing certain separators with semicolons,</span>
<span class="sd">    removing duplicates, and removing stopwords.</span>
<span class="sd">    The function returns the cleaned string.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    input_string (str): The input string.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The cleaned string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">separators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">separators</span><span class="p">:</span>
        <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="c1"># make the string unique in items</span>
    <span class="n">input_string</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))))</span>
    <span class="n">input_string</span> <span class="o">=</span> <span class="n">remove_stopwords</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">input_string</span></div>


<div class="viewcode-block" id="remove_stopwords">
<a class="viewcode-back" href="../../src.html#src.io_functions.remove_stopwords">[docs]</a>
<span class="k">def</span> <span class="nf">remove_stopwords</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a string as input and removes stopwords from it.</span>
<span class="sd">    The function returns the string with stopwords removed.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    text (str): The input string.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The string with stopwords removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stopwords</span> <span class="o">=</span> <span class="n">get_stopwords</span><span class="p">()</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">filtered_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stopwords</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_words</span><span class="p">)</span></div>


<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<div class="viewcode-block" id="get_stopwords">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_stopwords">[docs]</a>
<span class="k">def</span> <span class="nf">get_stopwords</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;stopwords.json&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads a JSON file containing stopwords and returns a list of stopwords.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    source (str): The path to the JSON file containing stopwords. Default is &#39;stopwords.json&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    List[str]: A list of stopwords.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stopwords&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[]</span></div>


<span class="k">def</span> <span class="nf">get_secret_api_parameters</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;../secrets/api_secrets.json&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rspace&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads a JSON file containing secret API parameters and returns a dictionary of parameters for a specific type.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    source (str): The path to the JSON file containing secret API parameters. Default is &#39;../secrets/api_secrets.json&#39;.</span>
<span class="sd">    type (str): The type of API parameters to return. Default is &#39;rspace&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Dict[str, any]: A dictionary of API parameters for the specified type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{}</span>

<div class="viewcode-block" id="delete_duplicate_tags">
<a class="viewcode-back" href="../../src.html#src.io_functions.delete_duplicate_tags">[docs]</a>
<span class="k">def</span> <span class="nf">delete_duplicate_tags</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="s2">&quot;sync_database.db&quot;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function deletes duplicate tags from a SQLite database table.</span>
<span class="sd">    It takes the database name as input and returns 0 if the operation is successful.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database. Default is &#39;./data/sync_database.db&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    int: 0 if the operation is successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Connect to the SQLite database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

    <span class="c1"># Create a cursor object</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Execute the SQL command to delete duplicates</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        DELETE FROM tag</span>
<span class="s2">        WHERE rowid NOT IN (</span>
<span class="s2">            SELECT MIN(rowid)</span>
<span class="s2">            FROM tag</span>
<span class="s2">            GROUP BY translated_tag_name, object_id</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Commit the changes</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Close the connection</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<div class="viewcode-block" id="delete_duplicate_objects">
<a class="viewcode-back" href="../../src.html#src.io_functions.delete_duplicate_objects">[docs]</a>
<span class="k">def</span> <span class="nf">delete_duplicate_objects</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="s2">&quot;sync_database.db&quot;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function deletes duplicate objects from a SQLite database table.</span>
<span class="sd">    It takes the database name as input and returns 0 if the operation is successful.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database. Default is &#39;./data/sync_database.db&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    int: 0 if the operation is successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Connect to the SQLite database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

    <span class="c1"># Create a cursor object</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Execute the SQL command to delete duplicates</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        DELETE FROM object</span>
<span class="s2">        WHERE rowid NOT IN (</span>
<span class="s2">            SELECT MIN(rowid)</span>
<span class="s2">            FROM object</span>
<span class="s2">            GROUP BY object_name, object_type, specific_id, user, created_timestamp, modified_timestamp, notes, source</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Commit the changes</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Close the connection</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="delete_duplicate_links">
<a class="viewcode-back" href="../../src.html#src.io_functions.delete_duplicate_links">[docs]</a>
<span class="k">def</span> <span class="nf">delete_duplicate_links</span><span class="p">(</span><span class="n">db_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="s2">&quot;sync_database.db&quot;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function deletes duplicate links from a SQLite database table.</span>
<span class="sd">    It takes the database name as input.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database. Default is &#39;./data/sync_database.db&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Connect to the SQLite database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

    <span class="c1"># Create a cursor object</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Execute the SQL command to delete duplicates</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        DELETE FROM link</span>
<span class="s2">        WHERE rowid NOT IN (</span>
<span class="s2">            SELECT MIN(rowid)</span>
<span class="s2">            FROM link</span>
<span class="s2">            GROUP BY src_id, src_table, tar_id, tar_table, tar_source, overlap_ratio</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Commit the changes</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Close the connection</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_secret_api_parameters">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_secret_api_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">get_secret_api_parameters</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;api_secrets.json&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rspace&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads a JSON file containing secret API parameters and returns a dictionary of parameters for a specific type.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    source (str): The path to the JSON file containing secret API parameters. Default is &#39;api_secrets.json&#39;.</span>
<span class="sd">    type (str): The type of API parameters to return. Default is &#39;rspace&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Dict[str, any]: A dictionary of API parameters for the specified type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="get_sample_data_from_barcode">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_sample_data_from_barcode">[docs]</a>
<span class="k">def</span> <span class="nf">get_sample_data_from_barcode</span><span class="p">(</span><span class="n">sampleParameter</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">elnName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rspace&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves sample data from a barcode using the RSpace API.</span>
<span class="sd">    It takes the sample parameter and the ELN name as input and returns a dictionary containing the sample data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    sampleParameter (str): The sample parameter.</span>
<span class="sd">    elnName (str): The ELN name. Default is &#39;rspace&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Dict[str, any]: A dictionary containing the sample data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">apiParams</span> <span class="o">=</span> <span class="n">get_secret_api_parameters</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="o">*</span><span class="p">[</span><span class="n">apiParams</span><span class="p">[</span><span class="s1">&#39;apiUrl&#39;</span><span class="p">],</span> <span class="n">apiParams</span><span class="p">[</span><span class="s1">&#39;apiInventoryPath&#39;</span><span class="p">],</span> <span class="n">apiParams</span><span class="p">[</span><span class="s1">&#39;apiSearchFile&#39;</span><span class="p">]])</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
               <span class="s2">&quot;apiKey&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">apiParams</span><span class="p">[</span><span class="s1">&#39;apiKey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

    <span class="c1"># create the search-json for searching in rspace-inventory</span>
    <span class="k">if</span> <span class="n">elnName</span> <span class="o">==</span> <span class="s1">&#39;rspace&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pageNumber&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;pageSize&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;orderBy&quot;</span><span class="p">:</span> <span class="s2">&quot;name asc&quot;</span><span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="get_object_id_from_specific_id">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_object_id_from_specific_id">[docs]</a>
<span class="k">def</span> <span class="nf">get_object_id_from_specific_id</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">specific_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves the object ID from a specific ID in a SQLite database table.</span>
<span class="sd">    It takes the database name, table name, and specific ID as input and returns the object ID if it exists, or None otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    table_name (str): The name of the table to search in.</span>
<span class="sd">    specific_id (str): The specific ID to search for.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Optional[int]: The object ID if it exists, or None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Connect to the database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># SQL command to check for the specific value and retrieve the object_id</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT object_id FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> WHERE specific_id = ?;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">specific_id</span><span class="p">,)</span>  <span class="c1"># Note the comma to create a tuple</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Return the object_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Return None if specific_id is not found</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An error occurred:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<div class="viewcode-block" id="get_object_id_from_netstore_name">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_object_id_from_netstore_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_object_id_from_netstore_name</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">netstore_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves the object ID from a NetStore name in a SQLite database table.</span>
<span class="sd">    It takes the database name, table name, and NetStore name as input and returns the object ID if it exists, or None otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    table_name (str): The name of the table to search in.</span>
<span class="sd">    netstore_name (str): The NetStore name to search for.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Optional[int]: The object ID if it exists, or None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Connect to the database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># SQL command to check for the specific value and retrieve the object_id</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT object_id FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> WHERE object_name = ? AND source = ?;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">netstore_name</span><span class="p">,</span> <span class="s1">&#39;fs_storage&#39;</span><span class="p">)</span>  <span class="c1"># Note the comma to create a tuple</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Return the object_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Return None if specific_id is not found</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An error occurred:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_int_from_date">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_int_from_date">[docs]</a>
<span class="k">def</span> <span class="nf">get_int_from_date</span><span class="p">(</span><span class="n">date_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function converts a date string in the format &quot;YYYY-MM-DD&quot; to an integer representing the number of days since the Unix epoch.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    date_str (str): The date string in the format &quot;YYYY-MM-DD&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    int: The number of days since the Unix epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert the date string to a datetime object</span>
    <span class="n">date_obj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Convert the datetime object to the number of days since the Unix epoch</span>
    <span class="n">days_since_epoch</span> <span class="o">=</span> <span class="n">date_obj</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>

    <span class="c1"># Convert the number of days to an integer</span>
    <span class="n">days_since_epoch_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">days_since_epoch</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">days_since_epoch_int</span></div>


<div class="viewcode-block" id="convert_abbreviations">
<a class="viewcode-back" href="../../src.html#src.io_functions.convert_abbreviations">[docs]</a>
<span class="k">def</span> <span class="nf">convert_abbreviations</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">colname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tags&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function replaces abbreviations in a DataFrame column with their full forms using a dictionary of abbreviations.</span>
<span class="sd">    It takes a DataFrame and a column name as input and returns the updated DataFrame.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df (pd.DataFrame): The input DataFrame.</span>
<span class="sd">    colname (str): The name of the column containing the tags. Default is &quot;tags&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: The updated DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abbDict</span> <span class="o">=</span> <span class="n">get_abbreviation_dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">abbDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_tags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colname</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_abbreviation">
<a class="viewcode-back" href="../../src.html#src.io_functions.convert_abbreviation">[docs]</a>
<span class="k">def</span> <span class="nf">convert_abbreviation</span><span class="p">(</span><span class="n">og_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function converts a string of abbreviations into a string of full forms using a dictionary of abbreviations.</span>
<span class="sd">    It takes a string as input and returns the updated string.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    og_string (str): The input string containing the abbreviations.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The updated string containing the full forms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abbDict</span> <span class="o">=</span> <span class="n">get_abbreviation_dict</span><span class="p">()</span>
    <span class="n">og_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">og_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)))</span>
    <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">abbDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">abbDict</span> <span class="k">else</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">og_list</span><span class="p">])</span></div>


<span class="k">def</span> <span class="nf">process_tags</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">colname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tags&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function removes duplicates from a DataFrame column containing tags.</span>
<span class="sd">    It takes a DataFrame and a column name as input and returns the updated DataFrame.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df (pd.DataFrame): The input DataFrame.</span>
<span class="sd">    colname (str): The name of the column containing the tags. Default is &quot;tags&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: The updated DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<div class="viewcode-block" id="get_possible_tags_list">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_possible_tags_list">[docs]</a>
<span class="k">def</span> <span class="nf">get_possible_tags_list</span><span class="p">(</span><span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function filters a list of tags based on certain patterns to remove irrelevant or invalid tags.</span>
<span class="sd">    It takes a list of tags as input and returns the filtered list of tags.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    tags (List[str]): The list of tags to filter.</span>

<span class="sd">    Returns:</span>
<span class="sd">    List[str]: The filtered list of tags.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span>  <span class="c1"># Matches any number</span>
        <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z]{1,2}$&#39;</span><span class="p">,</span>  <span class="c1"># Matches any string of length 1 or 2</span>
        <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z\d]</span><span class="si">{4}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="c1"># Matches any string of length 4</span>
        <span class="c1"># Matches any string that contains both letters and numbers</span>
        <span class="sa">r</span><span class="s1">&#39;^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]+$&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;^.*\^.*$&#39;</span>  <span class="c1"># Matches any string that contains the &quot;^&quot; character</span>
    <span class="p">]</span>

    <span class="c1"># Filter the list</span>
    <span class="n">filtered_lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
    <span class="n">filtered_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filtered_lst</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">filtered_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">filtered_lst</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">filtered_lst</span></div>


<span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="n">df_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;sync_database.db&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves a DataFrame from a SQLite database based on the specified dataframe type.</span>
<span class="sd">    It takes the dataframe type and the database name as input and returns the DataFrame.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df_type (str): The type of DataFrame to retrieve.</span>
<span class="sd">    db_name (str): The name of the SQLite database. Default is &#39;sync_database.db&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: The retrieved DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;link&quot;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM link;&quot;</span>
    <span class="k">elif</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;egroupware&quot;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM project_registration&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM object WHERE source = &#39;</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">&#39;;&quot;</span>

    <span class="c1"># Begin a transaction</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

    <span class="c1"># Commit the transaction</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="calculate_percentage">
<a class="viewcode-back" href="../../src.html#src.io_functions.calculate_percentage">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_percentage</span><span class="p">(</span><span class="n">str1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">str2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates the percentage of common characters between two strings.</span>
<span class="sd">    It takes two strings as input and returns the percentage of common characters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    str1 (str): The first string.</span>
<span class="sd">    str2 (str): The second string.</span>

<span class="sd">    Returns:</span>
<span class="sd">    float: The percentage of common characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">str1</span> <span class="ow">in</span> <span class="n">str2</span> <span class="ow">or</span> <span class="n">str2</span> <span class="ow">in</span> <span class="n">str1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">common_chars</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">common_chars</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">str1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">str2</span><span class="p">)))</span></div>


<div class="viewcode-block" id="get_df_name">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_df_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_df_name</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves the name of a DataFrame variable.</span>
<span class="sd">    It takes a DataFrame as input and returns the name of the variable.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    var (pd.DataFrame): The DataFrame variable.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The name of the DataFrame variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">inspect</span>
    <span class="n">callers_local_vars</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="n">df_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_name</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span>
               <span class="n">var_val</span> <span class="ow">in</span> <span class="n">callers_local_vars</span> <span class="k">if</span> <span class="n">var_val</span> <span class="ow">is</span> <span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df_name</span></div>


<span class="k">def</span> <span class="nf">get_col_overlap_df</span><span class="p">(</span><span class="n">df1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">colname1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">colname2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates the percentage of common characters between two columns of two DataFrames.</span>
<span class="sd">    It takes two DataFrames and two column names as input and returns a DataFrame containing the combinations of values and their corresponding percentage of common characters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df1 (pd.DataFrame): The first DataFrame.</span>
<span class="sd">    df2 (pd.DataFrame): The second DataFrame.</span>
<span class="sd">    colname1 (str): The name of the column in the first DataFrame.</span>
<span class="sd">    colname2 (str): The name of the column in the second DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the combinations of values and their corresponding percentage of common characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">row1</span><span class="p">),</span> <span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">row2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">df2</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
        <span class="n">combination</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row1</span><span class="p">[</span><span class="n">colname1</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">row2</span><span class="p">[</span><span class="n">colname2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="n">calculate_percentage</span><span class="p">(</span><span class="n">row1</span><span class="p">[</span><span class="n">colname1</span><span class="p">],</span> <span class="n">row2</span><span class="p">[</span><span class="n">colname2</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">combination</span><span class="p">,</span> <span class="n">percentage</span><span class="p">))</span>
    <span class="n">df_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_df_name</span><span class="p">(</span><span class="n">df1</span><span class="p">),</span> <span class="n">get_df_name</span><span class="p">(</span><span class="n">df2</span><span class="p">)]</span>
    <span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_names</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">colname1</span><span class="p">,</span> <span class="s1">&#39;percentage&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;percentage&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_binary_overlap</span><span class="p">(</span><span class="n">df1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates the binary overlap between two columns of two DataFrames based on a time difference threshold.</span>
<span class="sd">    It takes two DataFrames, two column names, and a time difference threshold as input and returns a DataFrame containing the binary overlap.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df1 (pd.DataFrame): The first DataFrame.</span>
<span class="sd">    col1 (str): The name of the column in the first DataFrame.</span>
<span class="sd">    df2 (pd.DataFrame): The second DataFrame.</span>
<span class="sd">    col2 (str): The name of the column in the second DataFrame.</span>
<span class="sd">    epsilon (int): The time difference threshold.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the binary overlap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create an empty DataFrame to store the results</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># Iterate over each pair of timestamps</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="c1"># Calculate the time difference</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">get_int_timestamp_from_iso</span><span class="p">(</span>
                <span class="n">df1</span><span class="p">[</span><span class="n">col1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">get_int_timestamp_from_iso</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">col2</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
            <span class="c1"># If the difference is less than or equal to epsilon, set the result to 1</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>

<div class="viewcode-block" id="create_system_overlap">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_system_overlap">[docs]</a>
<span class="k">def</span> <span class="nf">create_system_overlap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a DataFrame containing the overlap between egroupware and netstore DataFrames based on project, author, and tags columns.</span>
<span class="sd">    It returns the DataFrame containing the overlap.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the overlap between egroupware and netstore DataFrames.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">egroupware_df</span> <span class="o">=</span> <span class="n">get_dataframe</span><span class="p">(</span><span class="s2">&quot;egroupware&quot;</span><span class="p">)</span>
    <span class="n">netstore_df</span> <span class="o">=</span> <span class="n">get_dataframe</span><span class="p">(</span><span class="s2">&quot;netstore&quot;</span><span class="p">)</span>

    <span class="n">cpl_overlap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">]):</span>
        <span class="n">df_result</span> <span class="o">=</span> <span class="n">get_col_overlap_df</span><span class="p">(</span><span class="n">egroupware_df</span><span class="p">,</span> <span class="n">netstore_df</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
        <span class="n">df_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_result</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">df_result</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="n">cpl_overlap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cpl_overlap_df</span><span class="p">,</span> <span class="n">df_result</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cpl_overlap_df</span> <span class="o">=</span> <span class="n">convert_abbreviations</span><span class="p">(</span><span class="n">cpl_overlap_df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cpl_overlap_df</span></div>


<div class="viewcode-block" id="is_string_in_list">
<a class="viewcode-back" href="../../src.html#src.io_functions.is_string_in_list">[docs]</a>
<span class="k">def</span> <span class="nf">is_string_in_list</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lst</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks if a string is present in a list of tuples and returns the corresponding value.</span>
<span class="sd">    It takes a string and a list of tuples as input and returns the corresponding value if the string is present, or False otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    s (str): The string to search for.</span>
<span class="sd">    lst (List[Tuple[str, int]]): The list of tuples to search in.</span>

<span class="sd">    Returns:</span>
<span class="sd">    int: The corresponding value if the string is present, or False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_tags_tuple">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_tags_tuple">[docs]</a>
<span class="k">def</span> <span class="nf">get_tags_tuple</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inplace&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves a list of tuples containing tag names and IDs for a specific user.</span>
<span class="sd">    It takes a connection object and a user name as input and returns a list of tuples containing tag names and IDs.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    conn (object): The connection object.</span>
<span class="sd">    user (str): The user name. Default is &#39;inplace&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    List[Tuple[str, int]]: A list of tuples containing tag names and IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getObjects</span><span class="p">(</span><span class="s2">&quot;TagAnnotation&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">getOwner</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tag</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span> <span class="n">tag</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_tag_description">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_tag_description">[docs]</a>
<span class="k">def</span> <span class="nf">get_tag_description</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">descriptions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves the description of a tag from a dictionary of descriptions.</span>
<span class="sd">    It takes a tag name and a dictionary of descriptions as input and returns the description of the tag if it is present, or an empty string otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    tag (str): The tag name.</span>
<span class="sd">    descriptions (dict): A dictionary of descriptions. Default is the output of get_description_dict().</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The description of the tag if it is present, or an empty string otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">descriptions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">descriptions</span> <span class="o">=</span> <span class="n">get_description_dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">descriptions</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="delete_duplicates_bulk_import">
<a class="viewcode-back" href="../../src.html#src.io_functions.delete_duplicates_bulk_import">[docs]</a>
<span class="k">def</span> <span class="nf">delete_duplicates_bulk_import</span><span class="p">(</span><span class="n">bulk_file_src_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function removes duplicate rows from a CSV file containing a list of files/folders to be imported into OMERO.</span>
<span class="sd">    It takes the source file path as input.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    bulk_file_src_path (str): The source file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the CSV file into a DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">bulk_file_src_path</span><span class="p">)</span>

    <span class="c1"># Remove duplicate rows</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># Write the DataFrame back to the CSV file</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">bulk_file_src_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="omero_inplace_bulk_import">
<a class="viewcode-back" href="../../src.html#src.io_functions.omero_inplace_bulk_import">[docs]</a>
<span class="k">def</span> <span class="nf">omero_inplace_bulk_import</span><span class="p">(</span><span class="n">bulk_file_src_path</span><span class="p">,</span>
                              <span class="n">bulk_file_tar_path</span><span class="o">=</span><span class="s1">&#39;~/groups/omero-import&#39;</span><span class="p">,</span>
                              <span class="n">docker_vol_path</span><span class="o">=</span><span class="s1">&#39;/NETSTORE_omero-import&#39;</span><span class="p">,</span>
                              <span class="n">server</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;inplace&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;omero&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs an bulk inplace import of csv file list of files/folder into target datasets on an OMERO server using Docker.</span>
<span class="sd">    It takes the target dataset, source file path, Docker volume path, server address, username, and password as input.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    bulk_file_src_path (str): The source file path.</span>
<span class="sd">    bulk_file_tar_path (str): The target file path. Default is &#39;~/groups/omero-import&#39;.</span>
<span class="sd">    docker_vol_path (str): The Docker volume path. Default is &#39;/NETSTORE_omero-import&#39;.</span>
<span class="sd">    server (str): The server address. Default is &#39;localhost&#39;.</span>
<span class="sd">    username (str): The username. Default is &#39;inplace&#39;.</span>
<span class="sd">    password (str): The password. Default is &#39;omero&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">delete_duplicates_bulk_import</span><span class="p">(</span><span class="n">bulk_file_src_path</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">shutil</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bulk_file_src_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">bulk_file_tar_path</span><span class="p">,</span> <span class="n">bulk_file_src_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/opt/omero/server/OMERO.server-5.6.9-ice36/bin/omero import&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;-s </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;-u </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;-w </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;--bulk </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docker_vol_path</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;bulk.yml&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
               <span class="p">]</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;docker&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="s1">&#39;-it&#39;</span><span class="p">,</span> <span class="s1">&#39;omeroserver_docker&#39;</span><span class="p">,</span>
               <span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span></div>

    <span class="c1"># print(&quot;Current path:&quot;, output)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">omero.gateway</span> <span class="kn">import</span> <span class="n">BlitzGateway</span>
<span class="kn">from</span> <span class="nn">omero.model</span> <span class="kn">import</span> <span class="n">OriginalFileI</span><span class="p">,</span> <span class="n">ProjectAnnotationLinkI</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<div class="viewcode-block" id="omero_inplace_import">
<a class="viewcode-back" href="../../src.html#src.io_functions.omero_inplace_import">[docs]</a>
<span class="k">def</span> <span class="nf">omero_inplace_import</span><span class="p">(</span><span class="n">target_ds</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">docker_vol_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;/NETSTORE_omero-import&#39;</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inplace&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;omero&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs an inplace import of a source file into a target dataset on an OMERO server using Docker.</span>
<span class="sd">    It takes the target dataset, source file path, Docker volume path, server address, username, and password as input.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    target_ds (str): The target dataset.</span>
<span class="sd">    src (str): The source file path.</span>
<span class="sd">    docker_vol_path (str): The Docker volume path. Default is &#39;/NETSTORE_omero-import&#39;.</span>
<span class="sd">    server (str): The server address. Default is &#39;localhost&#39;.</span>
<span class="sd">    username (str): The username. Default is &#39;inplace&#39;.</span>
<span class="sd">    password (str): The password. Default is &#39;omero&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docker_vol_path</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">target_ds</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">target_type</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_type</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/opt/omero/server/OMERO.server-5.6.9-ice36/bin/omero import&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;-s </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;-u </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;-w </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;-T Dataset:</span><span class="si">{</span><span class="n">target_type</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">target_ds</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="s1">&#39;--transfer=ln_s&#39;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">]</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;docker&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="s1">&#39;-it&#39;</span><span class="p">,</span> <span class="s1">&#39;omeroserver_docker&#39;</span><span class="p">,</span>
               <span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current path:&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_attachment_to_project">
<a class="viewcode-back" href="../../src.html#src.io_functions.add_attachment_to_project">[docs]</a>
<span class="k">def</span> <span class="nf">add_attachment_to_project</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function adds an attachment to a project on an OMERO server.</span>
<span class="sd">    It takes the username, password, host, port, project ID, and file path as input.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    username (str): The username.</span>
<span class="sd">    password (str): The password.</span>
<span class="sd">    host (str): The host address.</span>
<span class="sd">    port (int): The port number.</span>
<span class="sd">    project_id (int): The project ID.</span>
<span class="sd">    file_path (str): The file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">project</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;Project&quot;</span><span class="p">,</span> <span class="n">project_id</span><span class="p">)</span>

    <span class="n">original_file</span> <span class="o">=</span> <span class="n">OriginalFileI</span><span class="p">()</span>
    <span class="n">original_file</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
    <span class="n">original_file</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
    <span class="n">original_file</span><span class="o">.</span><span class="n">setPath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">original_file</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getUpdateService</span><span class="p">()</span><span class="o">.</span><span class="n">saveAndReturnObject</span><span class="p">(</span><span class="n">original_file</span><span class="p">)</span>

    <span class="n">link</span> <span class="o">=</span> <span class="n">ProjectAnnotationLinkI</span><span class="p">()</span>
    <span class="n">link</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="n">link</span><span class="o">.</span><span class="n">setChild</span><span class="p">(</span><span class="n">original_file</span><span class="p">)</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getUpdateService</span><span class="p">()</span><span class="o">.</span><span class="n">saveAndReturnObject</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_project_timestamps_from_fs_storage">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_project_timestamps_from_fs_storage">[docs]</a>
<span class="k">def</span> <span class="nf">get_project_timestamps_from_fs_storage</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves the minimum created timestamp and the maximum timestamp between created and modified timestamps for a specific object ID in the fs_storage table of a SQLite database.</span>
<span class="sd">    It takes the database name and object ID as input and returns a tuple containing the minimum created timestamp and the maximum timestamp.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    object_id (int): The object ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Tuple[int, int]: A tuple containing the minimum created timestamp and the maximum timestamp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT min(created_timestamp)</span>
<span class="s2">        FROM fs_storage</span>
<span class="s2">        WHERE object_id = &#39;</span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">min_timestamp</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT max(</span>
<span class="s2">            CASE</span>
<span class="s2">                WHEN created_timestamp &gt; modified_timestamp THEN created_timestamp</span>
<span class="s2">                ELSE modified_timestamp</span>
<span class="s2">            END</span>
<span class="s2">        )</span>
<span class="s2">        FROM fs_storage</span>
<span class="s2">        WHERE object_id = &#39;</span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">max_timestamp</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">min_timestamp</span><span class="p">,</span> <span class="n">max_timestamp</span></div>


<span class="k">def</span> <span class="nf">get_file_stats</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves file statistics such as name, extension, size, creation timestamp, and modification timestamp for a given file path.</span>
<span class="sd">    It takes a file path as input and returns a dictionary containing the file statistics.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    file_path (str): The file path.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Dict[str, any]: A dictionary containing the file statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_path</span>
    <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
        <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> \
            <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="n">file_stats</span><span class="o">.</span><span class="n">st_size</span>
    <span class="n">created_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
        <span class="n">file_stats</span><span class="o">.</span><span class="n">st_ctime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="n">modified_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
        <span class="n">file_stats</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">file_extension</span><span class="p">,</span>
        <span class="s1">&#39;object_size&#39;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
        <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">created_timestamp</span><span class="p">,</span>
        <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">modified_timestamp</span><span class="p">,</span>
        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;netstore&#39;</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">get_current_username</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves the current username.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The current username.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="k">def</span> <span class="nf">create_rspace_folder</span><span class="p">(</span><span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apikey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a new folder in RSpace using the provided folder name and API key.</span>
<span class="sd">    It takes a folder name and an API key as input and returns the output of the curl command as a string.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    folder_name (str): The name of the folder to be created.</span>
<span class="sd">    apikey (str): The API key for authentication. Default is &quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The output of the curl command as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">folder_name</span><span class="p">,</span>
        <span class="s2">&quot;notebook&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
    <span class="p">}</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1/folders&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_rspace_document</span><span class="p">(</span><span class="n">doc_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parent_folder_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">apikey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a new document in RSpace using the provided document name, content, parent folder ID, tags, and API key.</span>
<span class="sd">    It takes a document name, content, parent folder ID, tags, and an API key as input and returns the output of the curl command as a string.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    doc_name (str): The name of the document to be created.</span>
<span class="sd">    content (str): The content of the document.</span>
<span class="sd">    parent_folder_id (str): The ID of the parent folder.</span>
<span class="sd">    tags (str): The tags for the document. Default is an empty string.</span>
<span class="sd">    apikey (str): The API key for authentication. Default is &quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The output of the curl command as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">doc_name</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
        <span class="s2">&quot;parentFolderId&quot;</span><span class="p">:</span> <span class="n">parent_folder_id</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1/documents&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">search_folder</span><span class="p">(</span><span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apikey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function searches for a folder in RSpace using the provided folder name, API key, and base URL.</span>
<span class="sd">    It takes a folder name, an API key, and a base URL as input and returns a dictionary containing the folder information if the folder is found, or 1 otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    folder_name (str): The name of the folder to be searched.</span>
<span class="sd">    apikey (str): The API key for authentication. Default is &quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;.</span>
<span class="sd">    base_url (str): The base URL of the RSpace API. Default is &quot;https://rstest.int.lin-magdeburg.de/api/v1&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Dict[str, any]: A dictionary containing the folder information if the folder is found, or 1 otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/folders/tree&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--silent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--show-error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--fail&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compressed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--get&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;typesToInclude=folder&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageNumber=0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageSize=20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;orderBy=lastModified desc&quot;</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;records&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">folder_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
    <span class="k">return</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">search_documents</span><span class="p">(</span><span class="n">doc_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apikey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function searches for a document in RSpace using the provided document name, API key, and base URL.</span>
<span class="sd">    It takes a document name, an API key, and a base URL as input and returns a dictionary containing the document information if the document is found, or 1 otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    doc_name (str): The name of the document to be searched.</span>
<span class="sd">    apikey (str): The API key for authentication. Default is &quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;.</span>
<span class="sd">    base_url (str): The base URL of the RSpace API. Default is &quot;https://rstest.int.lin-magdeburg.de/api/v1&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Dict[str, any]: A dictionary containing the document information if the document is found, or 1 otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/documents&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--silent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--show-error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--fail&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compressed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--get&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;query=</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;query&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">doc_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;queryType&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">})</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageNumber=0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageSize=20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;orderBy=lastModified desc&quot;</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;documents&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">doc_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
    <span class="k">return</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">get_placeholder_files_for_rspace</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns a list of placeholder files for RSpace.</span>

<span class="sd">    Returns:</span>
<span class="sd">    List[Dict[str, str]]: A list of dictionaries containing file information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;file1.xls&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/workspace/editor/structuredDocument/file1.xls&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sheet&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="s1">&#39;manuel&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;file2.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/workspace/editor/structuredDocument/file2.pdf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="s1">&#39;manuel&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;file3.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/workspace/editor/structuredDocument/file3.tif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;image (tif)&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;file4.tar&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/workspace/editor/structuredDocument/file4.tar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;archive (tar)&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="s1">&#39;manuel&#39;</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">files</span>

<span class="k">def</span> <span class="nf">generate_html_table</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">get_placeholder_files_for_rspace</span><span class="p">(),</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function generates an HTML table from a list of files.</span>
<span class="sd">    It takes a list of files and a header as input and returns an HTML table as a string.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    files (List[Dict[str, str]]): A list of dictionaries containing file information. Default is the output of get_placeholder_files_for_rspace().</span>
<span class="sd">    header (str): An optional header for the table. Default is an empty string.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: An HTML table as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table_html</span> <span class="o">=</span> <span class="s2">&quot;&lt;table style=&#39;border-collapse: collapse; width: 100%;&#39;&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;  &lt;tbody&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;         &lt;th&gt;&lt;strong&gt;File Name&lt;/strong&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;         &lt;th&gt;&lt;strong&gt;File Type&lt;/strong&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;         &lt;th&gt;&lt;strong&gt;File Metadata&lt;/strong&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;         &lt;th&gt;&lt;strong&gt;Data Access&lt;/strong&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="n">file_type</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">file_metadata</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
        <span class="n">data_access</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;access&#39;</span><span class="p">]</span>

        <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      &lt;td&gt;&lt;a href=&#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&gt;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&lt;/a&gt;&lt;/td&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      &lt;td&gt;</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      &lt;td&gt;</span><span class="si">{</span><span class="n">file_metadata</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      &lt;td&gt;</span><span class="si">{</span><span class="n">data_access</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;  &lt;/tbody&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/table&gt;&quot;</span>

    <span class="k">if</span> <span class="n">header</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">table_html</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">table_html</span>

    <span class="k">return</span> <span class="n">table_html</span>

<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">def</span> <span class="nf">search_documents</span><span class="p">(</span><span class="n">doc_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apikey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function searches for a document in RSpace using the provided document name, API key, and base URL.</span>
<span class="sd">    It takes a document name, an API key, and a base URL as input and returns a dictionary containing the document information if the document is found, or 1 otherwise.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    doc_name (str): The name of the document to be searched.</span>
<span class="sd">    apikey (str): The API key for authentication. Default is &quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;.</span>
<span class="sd">    base_url (str): The base URL of the RSpace API. Default is &quot;https://rstest.int.lin-magdeburg.de/api/v1&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Dict[str, any]: A dictionary containing the document information if the document is found, or 1 otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/documents&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--silent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--show-error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--fail&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compressed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--get&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;query=</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;query&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">doc_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;queryType&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">})</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageNumber=0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageSize=20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;orderBy=lastModified desc&quot;</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;documents&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">doc_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
    <span class="k">return</span> <span class="mi">1</span>

<div class="viewcode-block" id="get_egroupware_data">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_egroupware_data">[docs]</a>
<span class="k">def</span> <span class="nf">get_egroupware_data</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves egroupware data for a specific project ID from a SQLite database.</span>
<span class="sd">    It takes a database name and a project ID as input and returns a DataFrame containing the egroupware data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    project_id (int): The project ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the egroupware data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">project_registration</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT * from project_registration WHERE project_id = </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">project_schedule</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT * from project_schedule WHERE project_id = </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">project_registration</span><span class="p">,</span>
                         <span class="n">project_schedule</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">joined_df</span></div>


<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<div class="viewcode-block" id="get_netstore_data">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_netstore_data">[docs]</a>
<span class="k">def</span> <span class="nf">get_netstore_data</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;fs_storage&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves netstore data for a specific object ID from a SQLite database.</span>
<span class="sd">    It takes a database name, an object ID, and a source as input and returns a DataFrame containing the netstore data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    object_id (int): The ID of the object to retrieve data for.</span>
<span class="sd">    source (str, optional): The source of the object data. Defaults to &#39;fs_storage&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the netstore data for the specified object ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="nb">object</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT * from object WHERE source = &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; and object_id = </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">fs_storage</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT * from fs_storage WHERE source = &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; and object_id = </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">fs_storage</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;object_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">joined_df</span></div>


<div class="viewcode-block" id="get_col_overlap_df">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_col_overlap_df">[docs]</a>
<span class="k">def</span> <span class="nf">get_col_overlap_df</span><span class="p">(</span><span class="n">df1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">colname1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">colname2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates the percentage of common characters between two columns of two DataFrames.</span>
<span class="sd">    It takes two DataFrames and two column names as input and returns a DataFrame containing the combinations of values and their corresponding percentage of common characters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df1 (pd.DataFrame): The first DataFrame.</span>
<span class="sd">    df2 (pd.DataFrame): The second DataFrame.</span>
<span class="sd">    colname1 (str): The name of the column in the first DataFrame.</span>
<span class="sd">    colname2 (str): The name of the column in the second DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the combinations of values and their corresponding percentage of common characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">row1</span><span class="p">),</span> <span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">row2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">df2</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
        <span class="n">combination</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row1</span><span class="p">[</span><span class="n">colname1</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">row2</span><span class="p">[</span><span class="n">colname2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="n">calculate_percentage</span><span class="p">(</span><span class="n">row1</span><span class="p">[</span><span class="n">colname1</span><span class="p">],</span> <span class="n">row2</span><span class="p">[</span><span class="n">colname2</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">combination</span><span class="p">,</span> <span class="n">percentage</span><span class="p">))</span>
    <span class="n">df_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_df_name</span><span class="p">(</span><span class="n">df1</span><span class="p">),</span> <span class="n">get_df_name</span><span class="p">(</span><span class="n">df2</span><span class="p">)]</span>
    <span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_names</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">colname1</span><span class="p">,</span> <span class="s1">&#39;percentage&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;percentage&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_binary_overlap">
<a class="viewcode-back" href="../../src.html#src.io_functions.calculate_binary_overlap">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_binary_overlap</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates the binary overlap between two columns of two DataFrames based on a given epsilon value.</span>
<span class="sd">    It takes two DataFrames, two column names, and an epsilon value as input and returns a DataFrame containing the binary overlap results.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df1 (pd.DataFrame): The first DataFrame.</span>
<span class="sd">    col1 (str): The name of the column in the first DataFrame.</span>
<span class="sd">    df2 (pd.DataFrame): The second DataFrame.</span>
<span class="sd">    col2 (str): The name of the column in the second DataFrame.</span>
<span class="sd">    epsilon (float): The maximum time difference allowed for a match.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the binary overlap results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create an empty DataFrame to store the results</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># Iterate over each pair of timestamps</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="c1"># Calculate the time difference</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">get_int_timestamp_from_iso</span><span class="p">(</span>
                <span class="n">df1</span><span class="p">[</span><span class="n">col1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">get_int_timestamp_from_iso</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">col2</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
            <span class="c1"># If the difference is less than or equal to epsilon, set the result to 1</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_dataframe">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_dataframe">[docs]</a>
<span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="n">df_type</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="s1">&#39;sync_database.db&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves data from a SQLite database based on the specified data type.</span>
<span class="sd">    It takes a data type and a database name as input and returns a DataFrame containing the retrieved data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df_type (str): The type of data to retrieve.</span>
<span class="sd">    db_name (str, optional): The name of the SQLite database. Defaults to &#39;sync_database.db&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the retrieved data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;link-fs_storage&quot;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM link WHERE tar_source = &#39;fs_storage&#39;;&quot;</span>
    <span class="k">if</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;link-omero&quot;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM link WHERE tar_source = &#39;omero&#39;;&quot;</span>
    <span class="k">if</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;link&quot;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM link;&quot;</span>
    <span class="k">if</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;egroupware&quot;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM project_registration&quot;</span>
    <span class="k">if</span> <span class="n">df_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rspace&quot;</span><span class="p">,</span> <span class="s2">&quot;fs_storage&quot;</span><span class="p">,</span> <span class="s2">&quot;omero&quot;</span><span class="p">]:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM object WHERE source = &#39;</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">&#39;;&quot;</span>

    <span class="c1"># Begin a transaction</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

    <span class="c1"># Commit the transaction</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_filelist_from_database">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_filelist_from_database">[docs]</a>
<span class="k">def</span> <span class="nf">get_filelist_from_database</span><span class="p">(</span><span class="n">tar_id</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="s1">&#39;sync_database.db&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves a file list from a SQLite database based on the specified target ID.</span>
<span class="sd">    It takes a target ID and a database name as input and returns a DataFrame containing the file list.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    tar_id (int): The target ID to retrieve the file list for.</span>
<span class="sd">    db_name (str, optional): The name of the SQLite database. Defaults to &#39;sync_database.db&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the file list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT * from fs_storage WHERE object_id = </span><span class="si">{</span><span class="n">tar_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT tar_id AS object_id, * from link WHERE tar_id = </span><span class="si">{</span><span class="n">tar_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

    <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span>
                         <span class="n">obj</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;object_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

    <span class="n">pr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SELECT project_id AS src_id, * from project_registration WHERE project_id = </span><span class="si">{</span><span class="n">joined_df</span><span class="p">[</span><span class="s1">&#39;src_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

    <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span>
                         <span class="n">pr</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;src_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">joined_df</span></div>


<span class="c1"># read out the objects linked together in the link-table (src_id = egroupware; tar_id = netstore)</span>


<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<div class="viewcode-block" id="get_link_object_from_id">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_link_object_from_id">[docs]</a>
<span class="k">def</span> <span class="nf">get_link_object_from_id</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves data from a SQLite database based on the specified table name and ID.</span>
<span class="sd">    It takes a database name, a table name, and an ID as input and returns a DataFrame containing the retrieved data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    table_name (str): The name of the table to retrieve data from.</span>
<span class="sd">    id (int): The ID to retrieve data for.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the retrieved data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;project_registration&quot;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> WHERE project_id = </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">;&quot;</span>

    <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> WHERE object_id = </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> and source = &#39;fs_storage&#39;;&quot;</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="check_for_omero_entries">
<a class="viewcode-back" href="../../src.html#src.io_functions.check_for_omero_entries">[docs]</a>
<span class="k">def</span> <span class="nf">check_for_omero_entries</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">omero_name</span><span class="p">,</span> <span class="n">object_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks for existing entries in the OMERO source of a SQLite database based on the specified OMERO name and object type.</span>
<span class="sd">    It takes a database name, an OMERO name, and an object type as input and returns a DataFrame containing the retrieved data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    omero_name (str): The OMERO name to check for.</span>
<span class="sd">    object_type (str): The object type to check for.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the retrieved data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM &#39;object&#39; WHERE object_name = &#39;</span><span class="si">{</span><span class="n">omero_name</span><span class="si">}</span><span class="s2">&#39; and source = &#39;omero&#39; and object_type = &#39;</span><span class="si">{</span><span class="n">object_type</span><span class="si">}</span><span class="s2">&#39;;&quot;</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_dataset_fs_storage_name">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_dataset_fs_storage_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_dataset_fs_storage_name</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">base_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves data from the fs_storage source of a SQLite database based on the specified base path.</span>
<span class="sd">    It takes a database name and a base path as input and returns a DataFrame containing the retrieved data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the SQLite database.</span>
<span class="sd">    base_path (str): The base path to retrieve data for.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: A DataFrame containing the retrieved data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM fs_storage WHERE object_name LIKE &#39;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">%&#39; and source = &#39;fs_storage&#39;;&quot;</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="k">def</span> <span class="nf">convert_omero_timestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function converts an OMERO timestamp to a standard timestamp format.</span>
<span class="sd">    It takes a timestamp as input and returns the converted timestamp.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    timestamp (str): The timestamp to convert.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The converted timestamp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">auto_insert_omero_to_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function automatically inserts OMERO data into a SQLite database.</span>
<span class="sd">    It establishes a connection to the OMERO server, extracts data from projects, datasets, and images,</span>
<span class="sd">    and inserts the data into the database. It also handles tags and removes duplicates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Establish a connection to the OMERO server</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;omero&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">4064</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="c1"># Define the database and table names</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="s1">&#39;sync_database.db&#39;</span>
    <span class="n">object_table_name</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span>
    <span class="n">tag_table_name</span> <span class="o">=</span> <span class="s1">&#39;tag&#39;</span>

    <span class="c1"># Check if the database and tables exist, if not, create them</span>
    <span class="n">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">object_table_name</span><span class="p">)</span>
    <span class="n">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">tag_table_name</span><span class="p">)</span>

    <span class="c1"># Get all projects from OMERO</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getObjects</span><span class="p">(</span><span class="s2">&quot;Project&quot;</span><span class="p">)</span>

    <span class="c1"># Iterate over each project</span>
    <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">projects</span><span class="p">:</span>
        <span class="c1"># Extract project data</span>
        <span class="n">project_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
            <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">getOwnerOmeName</span><span class="p">(),</span>
            <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
            <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">updateEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
        <span class="p">}</span>
        <span class="c1"># Insert project data into the database</span>
        <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">object_table_name</span><span class="p">,</span> <span class="n">project_data</span><span class="p">)</span>

        <span class="c1"># Iterate over each tag in the project and add it to the database</span>
        <span class="k">for</span> <span class="n">tag_entry</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">listAnnotations</span><span class="p">():</span>
            <span class="c1"># Extract and process tag data</span>
            <span class="n">trans_note</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
            <span class="n">trans_note</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">trans_note</span><span class="p">)</span>
            <span class="n">tag_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;object_id&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;tag_name&#39;</span><span class="p">:</span> <span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span>
                <span class="s1">&#39;translated_tag_name&#39;</span><span class="p">:</span> <span class="n">trans_note</span><span class="p">,</span>
                <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">get_tag_description</span><span class="p">(</span><span class="n">trans_note</span><span class="p">),</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
            <span class="p">}</span>
            <span class="c1"># Insert tag data into the database</span>
            <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">tag_table_name</span><span class="p">,</span> <span class="n">tag_data</span><span class="p">)</span>

        <span class="c1"># Iterate over each dataset in the project</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">listChildren</span><span class="p">():</span>
            <span class="c1"># Extract dataset data</span>
            <span class="n">dataset_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">getOwnerOmeName</span><span class="p">(),</span>
                <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">updateEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
            <span class="p">}</span>
            <span class="c1"># Insert dataset data into the database</span>
            <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">object_table_name</span><span class="p">,</span> <span class="n">dataset_data</span><span class="p">)</span>

            <span class="c1"># Iterate over each tag in the dataset and add it to the database</span>
            <span class="k">for</span> <span class="n">tag_entry</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">listAnnotations</span><span class="p">():</span>
                <span class="c1"># Extract and process tag data</span>
                <span class="n">trans_note</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
                <span class="n">trans_note</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">trans_note</span><span class="p">)</span>
                <span class="n">tag_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;object_id&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;tag_name&#39;</span><span class="p">:</span> <span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span>
                    <span class="s1">&#39;translated_tag_name&#39;</span><span class="p">:</span> <span class="n">trans_note</span><span class="p">,</span>
                    <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                    <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                    <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">get_tag_description</span><span class="p">(</span><span class="n">trans_note</span><span class="p">),</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
                <span class="p">}</span>
                <span class="c1"># Insert tag data into the database</span>
                <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">tag_table_name</span><span class="p">,</span> <span class="n">tag_data</span><span class="p">)</span>

            <span class="c1"># Iterate over each image in the dataset</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">listChildren</span><span class="p">():</span>
                <span class="c1"># Extract image data</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">getOwnerOmeName</span><span class="p">(),</span>
                    <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                    <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">updateEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                    <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
                <span class="p">}</span>
                <span class="c1"># Insert image data into the database</span>
                <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">object_table_name</span><span class="p">,</span> <span class="n">image_data</span><span class="p">)</span>

                <span class="c1"># Iterate over each tag in the image and add it to the database</span>
                <span class="k">for</span> <span class="n">tag_entry</span> <span class="ow">in</span> <span class="n">image</span><span class="o">.</span><span class="n">listAnnotations</span><span class="p">():</span>
                    <span class="c1"># Extract and process tag data</span>
                    <span class="n">trans_note</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
                    <span class="n">trans_note</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">trans_note</span><span class="p">)</span>
                    <span class="n">tag_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;object_id&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;tag_name&#39;</span><span class="p">:</span> <span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span>
                        <span class="s1">&#39;translated_tag_name&#39;</span><span class="p">:</span> <span class="n">trans_note</span><span class="p">,</span>
                        <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                        <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                        <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">get_tag_description</span><span class="p">(</span><span class="n">trans_note</span><span class="p">),</span>
                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
                    <span class="p">}</span>
                    <span class="c1"># Insert tag data into the database</span>
                    <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">tag_table_name</span><span class="p">,</span> <span class="n">tag_data</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Remove duplicate objects and tags from the database</span>
    <span class="n">delete_duplicate_objects</span><span class="p">()</span>
    <span class="n">delete_duplicate_tags</span><span class="p">()</span>
    <span class="n">delete_duplicate_links</span><span class="p">()</span>


<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">re</span>

<div class="viewcode-block" id="get_tags_from_id">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_tags_from_id">[docs]</a>
<span class="k">def</span> <span class="nf">get_tags_from_id</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">df_type</span><span class="o">=</span><span class="s1">&#39;fs_storage&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves tags from the database based on the object id and source.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_name (str): The name of the database.</span>
<span class="sd">    id (int): The object id.</span>
<span class="sd">    df_type (str): The source type. Default is &#39;fs_storage&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    df (DataFrame): A pandas DataFrame containing the tag data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM tag WHERE object_id = </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> and source = &#39;</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">&#39;;&quot;</span>

    <span class="c1"># Begin a transaction</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

    <span class="c1"># Commit the transaction</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_file_stats">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_file_stats">[docs]</a>
<span class="k">def</span> <span class="nf">get_file_stats</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves file statistics such as name, extension, size, creation and modification timestamps.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    file_path (str): The path of the file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: A dictionary containing the file statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get file stats</span>
    <span class="n">file_stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="c1"># Extract required stats</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_path</span>
    <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
        <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> \
            <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="n">file_stats</span><span class="o">.</span><span class="n">st_size</span>
    <span class="n">created_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
        <span class="n">file_stats</span><span class="o">.</span><span class="n">st_ctime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="n">modified_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
        <span class="n">file_stats</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

    <span class="c1"># Return stats as a dictionary</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">file_extension</span><span class="p">,</span>
        <span class="s1">&#39;object_size&#39;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
        <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">created_timestamp</span><span class="p">,</span>
        <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">modified_timestamp</span><span class="p">,</span>
        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;fs_storage&#39;</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="get_current_username">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_current_username">[docs]</a>
<span class="k">def</span> <span class="nf">get_current_username</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves the current username.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The current username.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span></div>


<div class="viewcode-block" id="auto_insert_fs_storage_to_database">
<a class="viewcode-back" href="../../src.html#src.io_functions.auto_insert_fs_storage_to_database">[docs]</a>
<span class="k">def</span> <span class="nf">auto_insert_fs_storage_to_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function automatically inserts file storage data into the database.</span>
<span class="sd">    It retrieves project list and file dictionary from a netstore, then iterates over each project.</span>
<span class="sd">    For each project, it inserts object data into the database and retrieves the object id.</span>
<span class="sd">    Then, it iterates over each file in the project, retrieves file stats, and inserts them into the fs_storage table.</span>
<span class="sd">    It also extracts tags from the file path, cleans and converts them, and inserts them into the tag table.</span>
<span class="sd">    Finally, it removes duplicate objects and tags from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project_list</span><span class="p">,</span> <span class="n">file_dict</span> <span class="o">=</span> <span class="n">get_netstore_filelist</span><span class="p">()</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="s2">&quot;/home/omero-import&quot;</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="s1">&#39;sync_database.db&#39;</span>
    <span class="n">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s2">&quot;fs_storage&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_current_username</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">project_list</span><span class="p">:</span>
        <span class="nb">object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">proj</span><span class="p">,</span>
            <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Project&#39;</span><span class="p">,</span>
            <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">proj</span><span class="p">),</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">get_current_username</span><span class="p">(),</span>
            <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;fs_storage&#39;</span>
        <span class="p">}</span>

        <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
        <span class="n">object_id</span> <span class="o">=</span> <span class="n">get_object_id_from_netstore_name</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">)</span>

        <span class="c1"># if object_id &gt; 921: break ##testcase</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="p">[</span><span class="n">proj</span><span class="p">]:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">get_file_stats</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;object_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_id</span>
            <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s2">&quot;fs_storage&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>

            <span class="c1"># get the tags and insert it into the taglist</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">):]</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;/|-|_|\.|,&quot;</span>
            <span class="n">tags</span> <span class="o">+=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
            <span class="c1"># try to find the possible relevant tags (TODO: create a dictionary to white/black list tags)</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">get_possible_tags_list</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">trans_note</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">trans_note</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">trans_note</span><span class="p">)</span>
                <span class="n">tag_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;object_id&#39;</span><span class="p">:</span> <span class="n">object_id</span><span class="p">,</span>
                    <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;tag_name&#39;</span><span class="p">:</span> <span class="n">tag</span><span class="p">,</span>
                    <span class="s1">&#39;translated_tag_name&#39;</span><span class="p">:</span> <span class="n">trans_note</span><span class="p">,</span>
                    <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
                    <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">get_tag_description</span><span class="p">(</span><span class="n">trans_note</span><span class="p">),</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;fs_storage&#39;</span>
                <span class="p">}</span>
                <span class="c1"># Insert tag data into the database</span>
                <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="n">tag_data</span><span class="p">)</span>

                <span class="c1">###############</span>
                <span class="c1"># get min/max timestamp for files in fs_storage table</span>
                <span class="c1"># (min_timestamp, max_timestamp) = get_project_timestamps_from_fs_storage(db_name, object_id)</span>
                <span class="c1">###############</span>
    <span class="c1"># Remove duplicate objects and tags from the database</span>
    <span class="n">delete_duplicate_objects</span><span class="p">()</span>
    <span class="n">delete_duplicate_tags</span><span class="p">()</span></div>


<div class="viewcode-block" id="convert_omero_timestamp">
<a class="viewcode-back" href="../../src.html#src.io_functions.convert_omero_timestamp">[docs]</a>
<span class="k">def</span> <span class="nf">convert_omero_timestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function converts a timestamp from OMERO format to a standard format.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    timestamp (str): The timestamp in OMERO format.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The timestamp in standard format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="auto_insert_omero_to_database">
<a class="viewcode-back" href="../../src.html#src.io_functions.auto_insert_omero_to_database">[docs]</a>
<span class="k">def</span> <span class="nf">auto_insert_omero_to_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function automatically inserts OMERO data into the database.</span>
<span class="sd">    It establishes a connection to the OMERO server, retrieves all projects, and iterates over each project.</span>
<span class="sd">    For each project, it extracts project data, inserts it into the database, and iterates over each tag in the project,</span>
<span class="sd">    extracting and processing tag data and inserting it into the database.</span>
<span class="sd">    It then iterates over each dataset in the project, extracts dataset data, inserts it into the database,</span>
<span class="sd">    and iterates over each tag in the dataset, extracting and processing tag data and inserting it into the database.</span>
<span class="sd">    It then iterates over each image in the dataset, extracts image data, inserts it into the database,</span>
<span class="sd">    and iterates over each tag in the image, extracting and processing tag data and inserting it into the database.</span>
<span class="sd">    Finally, it removes duplicate objects and tags from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Establish a connection to the OMERO server</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;omero&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">4064</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="c1"># Define the database and table names</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="s1">&#39;sync_database.db&#39;</span>
    <span class="n">object_table_name</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span>
    <span class="n">tag_table_name</span> <span class="o">=</span> <span class="s1">&#39;tag&#39;</span>

    <span class="c1"># Check if the database and tables exist, if not, create them</span>
    <span class="n">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">object_table_name</span><span class="p">)</span>
    <span class="n">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">tag_table_name</span><span class="p">)</span>

    <span class="c1"># Get all projects from OMERO</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getObjects</span><span class="p">(</span><span class="s2">&quot;Project&quot;</span><span class="p">)</span>

    <span class="c1"># Iterate over each project</span>
    <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">projects</span><span class="p">:</span>
        <span class="c1"># Extract project data</span>
        <span class="n">project_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
            <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">getOwnerOmeName</span><span class="p">(),</span>
            <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
            <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">updateEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
        <span class="p">}</span>
        <span class="c1"># Insert project data into the database</span>
        <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">object_table_name</span><span class="p">,</span> <span class="n">project_data</span><span class="p">)</span>

        <span class="c1"># Iterate over each tag in the project and add it to the database</span>
        <span class="k">for</span> <span class="n">tag_entry</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">listAnnotations</span><span class="p">():</span>
            <span class="c1"># Extract and process tag data</span>
            <span class="n">trans_note</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
            <span class="n">trans_note</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">trans_note</span><span class="p">)</span>
            <span class="n">tag_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;object_id&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">project</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;tag_name&#39;</span><span class="p">:</span> <span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span>
                <span class="s1">&#39;translated_tag_name&#39;</span><span class="p">:</span> <span class="n">trans_note</span><span class="p">,</span>
                <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">get_tag_description</span><span class="p">(</span><span class="n">trans_note</span><span class="p">),</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
            <span class="p">}</span>
            <span class="c1"># Insert tag data into the database</span>
            <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">tag_table_name</span><span class="p">,</span> <span class="n">tag_data</span><span class="p">)</span>

        <span class="c1"># Iterate over each dataset in the project</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">listChildren</span><span class="p">():</span>
            <span class="c1"># Extract dataset data</span>
            <span class="n">dataset_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">getOwnerOmeName</span><span class="p">(),</span>
                <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">updateEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
            <span class="p">}</span>
            <span class="c1"># Insert dataset data into the database</span>
            <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">object_table_name</span><span class="p">,</span> <span class="n">dataset_data</span><span class="p">)</span>

            <span class="c1"># Iterate over each tag in the dataset and add it to the database</span>
            <span class="k">for</span> <span class="n">tag_entry</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">listAnnotations</span><span class="p">():</span>
                <span class="c1"># Extract and process tag data</span>
                <span class="n">trans_note</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
                <span class="n">trans_note</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">trans_note</span><span class="p">)</span>
                <span class="n">tag_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;object_id&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;tag_name&#39;</span><span class="p">:</span> <span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span>
                    <span class="s1">&#39;translated_tag_name&#39;</span><span class="p">:</span> <span class="n">trans_note</span><span class="p">,</span>
                    <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                    <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                    <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">get_tag_description</span><span class="p">(</span><span class="n">trans_note</span><span class="p">),</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
                <span class="p">}</span>
                <span class="c1"># Insert tag data into the database</span>
                <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">tag_table_name</span><span class="p">,</span> <span class="n">tag_data</span><span class="p">)</span>

            <span class="c1"># Iterate over each image in the dataset</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">listChildren</span><span class="p">():</span>
                <span class="c1"># Extract image data</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">getOwnerOmeName</span><span class="p">(),</span>
                    <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                    <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">updateEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                    <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
                <span class="p">}</span>
                <span class="c1"># Insert image data into the database</span>
                <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">object_table_name</span><span class="p">,</span> <span class="n">image_data</span><span class="p">)</span>

                <span class="c1"># Iterate over each tag in the image and add it to the database</span>
                <span class="k">for</span> <span class="n">tag_entry</span> <span class="ow">in</span> <span class="n">image</span><span class="o">.</span><span class="n">listAnnotations</span><span class="p">():</span>
                    <span class="c1"># Extract and process tag data</span>
                    <span class="n">trans_note</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
                    <span class="n">trans_note</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">trans_note</span><span class="p">)</span>
                    <span class="n">tag_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;object_id&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">simpleMarshal</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;tag_name&#39;</span><span class="p">:</span> <span class="n">tag_entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span>
                        <span class="s1">&#39;translated_tag_name&#39;</span><span class="p">:</span> <span class="n">trans_note</span><span class="p">,</span>
                        <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                        <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_omero_timestamp</span><span class="p">(</span><span class="n">tag_entry</span><span class="o">.</span><span class="n">creationEventDate</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
                        <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">get_tag_description</span><span class="p">(</span><span class="n">trans_note</span><span class="p">),</span>
                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span>
                    <span class="p">}</span>
                    <span class="c1"># Insert tag data into the database</span>
                    <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">tag_table_name</span><span class="p">,</span> <span class="n">tag_data</span><span class="p">)</span>

    <span class="c1"># Remove duplicate objects and tags from the database</span>
    <span class="n">delete_duplicate_objects</span><span class="p">()</span>
    <span class="n">delete_duplicate_tags</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="convert_rspace_timestamp">
<a class="viewcode-back" href="../../src.html#src.io_functions.convert_rspace_timestamp">[docs]</a>
<span class="k">def</span> <span class="nf">convert_rspace_timestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function converts a timestamp from RSpace format to a standard format.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    timestamp (str): The timestamp in RSpace format.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The timestamp in standard format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_rspace_documents">
<a class="viewcode-back" href="../../src.html#src.io_functions.process_rspace_documents">[docs]</a>
<span class="k">def</span> <span class="nf">process_rspace_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process RSpace documents and insert them into the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        documents (dict): A dictionary containing the RSpace documents.</span>
<span class="sd">        db_name (str): The name of the database.</span>
<span class="sd">        table_name (str): The name of the table to insert the documents into.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">[</span><span class="s1">&#39;documents&#39;</span><span class="p">]:</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">):</span>
            <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tagMetaData&#39;</span><span class="p">):</span>
            <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;tagMetaData&#39;</span><span class="p">]))</span>

        <span class="n">notes</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>

        <span class="n">object_document</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="s1">&#39;document&#39;</span><span class="p">,</span>
            <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;globalId&#39;</span><span class="p">],</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
            <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_rspace_timestamp</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_rspace_timestamp</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;lastModified&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">notes</span><span class="p">,</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;rspace&#39;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">check_if_entry_exists</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">object_document</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">object_document</span><span class="p">)</span>
        <span class="n">process_tags</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">object_document</span><span class="p">)</span></div>



<div class="viewcode-block" id="process_rspace_folder">
<a class="viewcode-back" href="../../src.html#src.io_functions.process_rspace_folder">[docs]</a>
<span class="k">def</span> <span class="nf">process_rspace_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process RSpace folders and insert them into the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        folders (dict): A dictionary containing the RSpace documents.</span>
<span class="sd">        db_name (str): The name of the database.</span>
<span class="sd">        table_name (str): The name of the table to insert the documents into.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">[</span><span class="s1">&#39;records&#39;</span><span class="p">]:</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">):</span>
            <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tagMetaData&#39;</span><span class="p">):</span>
            <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;tagMetaData&#39;</span><span class="p">]))</span>

        <span class="n">notes</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>

        <span class="n">object_document</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;object_name&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;object_type&#39;</span><span class="p">:</span> <span class="s1">&#39;folder&#39;</span><span class="p">,</span>
            <span class="s1">&#39;specific_id&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;globalId&#39;</span><span class="p">],</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
            <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_rspace_timestamp</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_rspace_timestamp</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;lastModified&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">notes</span><span class="p">,</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;rspace&#39;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">check_if_entry_exists</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">object_document</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">object_document</span><span class="p">)</span>
        <span class="n">process_tags</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">object_document</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_tags">
<a class="viewcode-back" href="../../src.html#src.io_functions.process_tags">[docs]</a>
<span class="k">def</span> <span class="nf">process_tags</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">object_document</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the tags of an RSpace document and insert them into the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        db_name (str): The name of the database.</span>
<span class="sd">        table_name (str): The name of the table to insert the tags into.</span>
<span class="sd">        doc (dict): The RSpace document.</span>
<span class="sd">        object_document (dict): The object document corresponding to the RSpace document.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">object_id</span> <span class="o">=</span> <span class="n">get_object_id_from_specific_id</span><span class="p">(</span>
        <span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;globalId&#39;</span><span class="p">])</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;tag&#39;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">object_document</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
        <span class="n">trans_note</span> <span class="o">=</span> <span class="n">get_cleaned_tag_string</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
        <span class="n">trans_note</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">trans_note</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trans_note</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;object_id&#39;</span><span class="p">:</span> <span class="n">object_id</span><span class="p">,</span>
            <span class="s1">&#39;tag_name&#39;</span><span class="p">:</span> <span class="n">note</span><span class="p">,</span>
            <span class="s1">&#39;translated_tag_name&#39;</span><span class="p">:</span> <span class="n">trans_note</span><span class="p">,</span>
            <span class="s1">&#39;created_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_rspace_timestamp</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;modified_timestamp&#39;</span><span class="p">:</span> <span class="n">convert_rspace_timestamp</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;lastModified&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">get_tag_description</span><span class="p">(</span><span class="n">trans_note</span><span class="p">),</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;rspace&#39;</span>
        <span class="p">}</span>

        <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_rspace_workspace_folders">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_rspace_workspace_folders">[docs]</a>
<span class="k">def</span> <span class="nf">get_rspace_workspace_folders</span><span class="p">(</span><span class="n">sampleParameter</span><span class="p">,</span> <span class="n">elnName</span><span class="o">=</span><span class="s1">&#39;rspace&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves workspace folders from RSpace inventory.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    sampleParameter (str): The sample parameter.</span>
<span class="sd">    elnName (str): The ELN name. Default is &#39;rspace&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: The JSON response containing the workspace folders.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">apiParams</span> <span class="o">=</span> <span class="n">get_secret_api_parameters</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="o">*</span><span class="p">[</span><span class="n">apiParams</span><span class="p">[</span><span class="s1">&#39;apiUrl&#39;</span><span class="p">],</span> <span class="n">apiParams</span><span class="p">[</span><span class="s1">&#39;apiInventoryPath&#39;</span><span class="p">],</span> <span class="n">apiParams</span><span class="p">[</span><span class="s1">&#39;apiWorkspaceFolder&#39;</span><span class="p">]])</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
               <span class="s2">&quot;apiKey&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">apiParams</span><span class="p">[</span><span class="s1">&#39;apiKey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="c1"># create the search-json for searching in rspace-inventory</span>
    <span class="k">if</span> <span class="n">elnName</span> <span class="o">==</span> <span class="s1">&#39;rspace&#39;</span><span class="p">:</span>
        <span class="n">insertDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pageNumber&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;pageSize&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;orderBy&quot;</span><span class="p">:</span> <span class="s2">&quot;name asc&quot;</span><span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="insert_egroupware">
<a class="viewcode-back" href="../../src.html#src.io_functions.insert_egroupware">[docs]</a>
<span class="k">def</span> <span class="nf">insert_egroupware</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function inserts project registration and schedule data from egroupware into the database.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    verbose (int): Verbosity level. Default is 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://egroupware.lin-magdeburg.de/abrechnung/api/projects.php?start=NaN&amp;end=NaN&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="s1">&#39;sync_database.db&#39;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;project_registration&#39;</span>
    <span class="n">check_db_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
    <span class="c1"># loop runs over all projects in egroupware</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
        <span class="c1"># take only HBI projects TODO: what about the other projects?</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;pm_group&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;HBI&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># insert every project registration into the database</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;project_registration&#39;</span>
        <span class="c1"># split project_name &amp; user from pm_title field</span>
        <span class="n">project_name</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="n">get_project_user_tuple</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;pm_title&#39;</span><span class="p">])</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">account_lid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;account_lid&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;account_lid&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">user</span><span class="p">,</span> <span class="n">account_lid</span><span class="p">])</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;;&quot;</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="c1"># get translation &amp; longer versions of short abbrevation to improve tag quality</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
        <span class="n">project_registration</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;project_id&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;pm_id&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;project_name&#39;</span><span class="p">:</span> <span class="n">project_name</span><span class="p">,</span>
                                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                                <span class="s1">&#39;start_timestamp&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;end_timestamp&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;resources&#39;</span><span class="p">:</span> <span class="n">resources</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">project_registration</span><span class="p">)</span>
        <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">project_registration</span><span class="p">)</span>
        <span class="c1">#####################################################################</span>
        <span class="c1"># insert every schedule for each project into the database</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;project_schedule&#39;</span>
        <span class="c1"># take it from egroupware</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://egroupware.lin-magdeburg.de/abrechnung/api/measurements.php?start=NaN&amp;end=NaN&amp;hrstol=48&amp;project=</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;pm_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="c1"># take everything from schedule data that could be used as tag (here: description. name, bemerkung)</span>
            <span class="c1"># take care that it works even if something is empty</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cal_description&#39;</span><span class="p">):</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;description:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;cal_description&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;name:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bemerkung&#39;</span><span class="p">):</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;bemerkung&#39;</span><span class="p">]))</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">convert_abbreviation</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
            <span class="n">project_schedule</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;schedule_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;cal_id&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;project_id&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;pm_id&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;part_name&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;cal_title&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                                <span class="s1">&#39;start_timestamp&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;human_cal_start&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;end_timestamp&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;human_cal_end&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">notes</span><span class="p">}</span>
            <span class="n">insert_dict_to_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">project_schedule</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">project_schedule</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_object">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_object">[docs]</a>
<span class="k">def</span> <span class="nf">create_object</span><span class="p">(</span><span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a new project or dataset in OMERO.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    project_name (str): The name of the project or dataset.</span>
<span class="sd">    type (str): The type of the object. It can be &#39;Project&#39; or &#39;Dataset&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    object: The newly created project or dataset object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use omero.gateway.Projectwrapper:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;omero&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">4064</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Project&#39;</span><span class="p">:</span>
        <span class="n">new_project</span> <span class="o">=</span> <span class="n">ProjectWrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">omero</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ProjectI</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Dataset&#39;</span><span class="p">:</span>
        <span class="n">new_project</span> <span class="o">=</span> <span class="n">DatasetWrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">omero</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DatasetI</span><span class="p">())</span>
    <span class="n">new_project</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
    <span class="n">new_project</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># print(&quot;New Project, Id:&quot;, new_dataset.id)</span>
    <span class="k">return</span> <span class="n">new_project</span></div>


<div class="viewcode-block" id="get_object_by_id">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_object_by_id">[docs]</a>
<span class="k">def</span> <span class="nf">get_object_by_id</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">project_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves an object from OMERO based on its name and ID.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    object_name (str): The name of the object.</span>
<span class="sd">    project_id (int): The ID of the object.</span>

<span class="sd">    Returns:</span>
<span class="sd">    object: The retrieved object if found, otherwise None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;omero&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">4064</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">object_name</span> <span class="o">==</span> <span class="s1">&#39;Tag&#39;</span><span class="p">:</span>
        <span class="n">object_name</span> <span class="o">=</span> <span class="s1">&#39;TagAnnotation&#39;</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">project_id</span><span class="p">)</span>
    <span class="c1"># print(type(project))</span>
    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">project</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="create_tag">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_tag">[docs]</a>
<span class="k">def</span> <span class="nf">create_tag</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_description</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a new tag in OMERO.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    tag_name (str): The name of the tag.</span>
<span class="sd">    tag_description (str): The description of the tag.</span>

<span class="sd">    Returns:</span>
<span class="sd">    object: The newly created tag object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;omero&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">4064</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">tag_ann</span> <span class="o">=</span> <span class="n">omero</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">TagAnnotationWrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">tag_ann</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
    <span class="n">tag_ann</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="n">tag_description</span><span class="p">)</span>
    <span class="n">tag_ann</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tag_ann</span></div>


<span class="c1"># high = parent object relative to low object (project -&gt; dataset -&gt; image -&gt; tag)</span>
<div class="viewcode-block" id="create_link">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_link">[docs]</a>
<span class="k">def</span> <span class="nf">create_link</span><span class="p">(</span><span class="n">high_object</span><span class="p">,</span> <span class="n">low_object</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;tag&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a link between two objects in OMERO.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    high_object (object): The parent object.</span>
<span class="sd">    low_object (object): The child object.</span>
<span class="sd">    type (str): The type of the link. Default is &#39;tag&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;omero&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">4064</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span>  <span class="c1"># high_object = project; low_object = tag</span>
            <span class="n">high_object</span><span class="o">.</span><span class="n">linkAnnotation</span><span class="p">(</span><span class="n">low_object</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;projectdataset&#39;</span><span class="p">:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">omero</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ProjectDatasetLinkI</span><span class="p">()</span>
            <span class="c1"># We can use a &#39;loaded&#39; object, but we might get an Exception</span>
            <span class="c1"># link.setChild(dataset_obj)</span>
            <span class="c1"># Better to use an &#39;unloaded&#39; object (loaded = False)</span>
            <span class="n">link</span><span class="o">.</span><span class="n">setChild</span><span class="p">(</span><span class="n">omero</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DatasetI</span><span class="p">(</span><span class="n">low_object</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">link</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="n">omero</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ProjectI</span><span class="p">(</span><span class="n">high_object</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">getUpdateService</span><span class="p">()</span><span class="o">.</span><span class="n">saveObject</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1"># Handle other unexpected errors</span>

<div class="viewcode-block" id="get_object_by_name">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_object_by_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_object_by_name</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">object_class</span><span class="o">=</span><span class="s2">&quot;Project&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function retrieves an object from OMERO based on its name and class.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    object_name (str): The name of the object.</span>
<span class="sd">    object_class (str): The class of the object. Default is &#39;Project&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    object: The ID of the retrieved object if found, otherwise None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Connect to the OMERO server</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;omero&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">4064</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="c1"># Query for projects with a given name</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getObjects</span><span class="p">(</span><span class="n">object_class</span><span class="p">)</span>

    <span class="c1"># Check if the project you&#39;re looking for is in the list</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">projects</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="n">object_name</span><span class="p">:</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">project_id</span>
            <span class="k">break</span>
    <span class="c1"># Close the connection to the OMERO server</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="create_rspace_folder">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_rspace_folder">[docs]</a>
<span class="k">def</span> <span class="nf">create_rspace_folder</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">apikey</span><span class="o">=</span><span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a new folder in RSpace.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    folder_name (str): The name of the folder.</span>
<span class="sd">    apikey (str): The API key. Default is &#39;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The output of the command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">folder_name</span><span class="p">,</span>
        <span class="s2">&quot;notebook&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
    <span class="p">}</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>  <span class="c1"># deaktivate ssl verification</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1/folders&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="c1"># print(output.decode())</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_rspace_document">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_rspace_document">[docs]</a>
<span class="k">def</span> <span class="nf">create_rspace_document</span><span class="p">(</span><span class="n">doc_name</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">parent_folder_id</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">apikey</span><span class="o">=</span><span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a new document in RSpace.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    doc_name (str): The name of the document.</span>
<span class="sd">    content (str): The content of the document.</span>
<span class="sd">    parent_folder_id (int): The ID of the parent folder.</span>
<span class="sd">    tags (str): The tags for the document. Default is an empty string.</span>
<span class="sd">    apikey (str): The API key. Default is &#39;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The output of the command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="kn">import</span> <span class="nn">json</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">doc_name</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
        <span class="s2">&quot;parentFolderId&quot;</span><span class="p">:</span> <span class="n">parent_folder_id</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>  <span class="c1"># deaktivate ssl verification</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1/documents&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="c1"># print(output.decode())</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span></div>


<div class="viewcode-block" id="search_folder">
<a class="viewcode-back" href="../../src.html#src.io_functions.search_folder">[docs]</a>
<span class="k">def</span> <span class="nf">search_folder</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">apikey</span><span class="o">=</span><span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function searches for a folder in RSpace.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    folder_name (str): The name of the folder.</span>
<span class="sd">    apikey (str): The API key. Default is &#39;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&#39;.</span>
<span class="sd">    base_url (str): The base URL. Default is &#39;https://rstest.int.lin-magdeburg.de/api/v1&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: The folder information if found, otherwise 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/folders/tree&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--silent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--show-error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--fail&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compressed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--get&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;typesToInclude=folder&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageNumber=0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageSize=20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;orderBy=lastModified desc&quot;</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="c1"># search all findings for the folder_name and return it</span>
    <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;records&#39;</span><span class="p">]:</span>
        <span class="c1"># TODO: if there&#39;re more than one folder sharing the same name; solve it!</span>
        <span class="c1"># here it works because it return just one</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">folder_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="search_documents">
<a class="viewcode-back" href="../../src.html#src.io_functions.search_documents">[docs]</a>
<span class="k">def</span> <span class="nf">search_documents</span><span class="p">(</span><span class="n">doc_name</span><span class="p">,</span> <span class="n">apikey</span><span class="o">=</span><span class="s2">&quot;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&quot;</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://rstest.int.lin-magdeburg.de/api/v1&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function searches for a document in RSpace.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    doc_name (str): The name of the document.</span>
<span class="sd">    apikey (str): The API key. Default is &#39;e7HV1YLT8BvhM2dSoVvzIyVK0svNexJq&#39;.</span>
<span class="sd">    base_url (str): The base URL. Default is &#39;https://rstest.int.lin-magdeburg.de/api/v1&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: The document information if found, otherwise 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/documents&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-k&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-X&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;accept: application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apiKey: </span><span class="si">{</span><span class="n">apikey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--silent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--show-error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--fail&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compressed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--get&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;query=</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;query&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">doc_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;queryType&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">})</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageNumber=0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;pageSize=20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data-urlencode&quot;</span><span class="p">,</span> <span class="s2">&quot;orderBy=lastModified desc&quot;</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="c1"># search all findings for the folder_name and return it</span>
    <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;documents&#39;</span><span class="p">]:</span>
        <span class="c1"># TODO: if there&#39;re more than one folder sharing the same name; solve it!</span>
        <span class="c1"># here it works because it return just one</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">doc_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="get_placeholder_files_for_rspace">
<a class="viewcode-back" href="../../src.html#src.io_functions.get_placeholder_files_for_rspace">[docs]</a>
<span class="k">def</span> <span class="nf">get_placeholder_files_for_rspace</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns placeholder files for RSpace.</span>

<span class="sd">    Returns:</span>
<span class="sd">    list: A list of placeholder files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># placeholder for real files in netstore or omero</span>
    <span class="c1"># TODO: connect files in omero with rspace</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;file1.xls&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/workspace/editor/structuredDocument/file1.xls&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sheet&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="s1">&#39;manuel&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;file2.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/workspace/editor/structuredDocument/file2.pdf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="s1">&#39;manuel&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;file3.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/workspace/editor/structuredDocument/file3.tif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;image (tif)&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="s1">&#39;omero&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;file4.tar&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/workspace/editor/structuredDocument/file4.tar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;archive (tar)&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="s1">&#39;manuel&#39;</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">files</span></div>


<div class="viewcode-block" id="create_rspace_files_table">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_rspace_files_table">[docs]</a>
<span class="k">def</span> <span class="nf">create_rspace_files_table</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">tar_id</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="s1">&#39;sync_database.db&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a table of files for RSpace.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    header (str): The header of the table.</span>
<span class="sd">    tar_id (int): The ID of the tar file.</span>
<span class="sd">    db_name (str): The name of the database. Default is &#39;sync_database.db&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    list: A list of files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fs_storage_df</span> <span class="o">=</span> <span class="n">get_filelist_from_database</span><span class="p">(</span><span class="n">tar_id</span><span class="p">)</span>
    <span class="c1"># print(fs_storage_df)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fs_storage_df</span><span class="p">[</span><span class="s1">&#39;project_name&#39;</span><span class="p">]):</span>

        <span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/omero-import/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="n">get_object_by_name</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span>
                                        <span class="n">object_class</span><span class="o">=</span><span class="s2">&quot;Project&quot;</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">BlitzGateway</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;omero&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">4064</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="n">project</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="s2">&quot;Project&quot;</span><span class="p">,</span> <span class="n">project_id</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">listChildren</span><span class="p">():</span>
                <span class="n">omero_link</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;http://localhost:4080/webclient/?show=dataset-</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># TODO: use only the filename for the specific file (e.g. this code only works for one img file in a dataset)</span>
                <span class="n">img_filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">listChildren</span><span class="p">():</span>
                    <span class="n">img_filename</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">img_filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="c1"># print(omero_image_object)</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">img_filename</span><span class="p">,</span>
                                  <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">fs_storage_df</span><span class="p">[</span><span class="s1">&#39;object_name&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                  <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">fs_storage_df</span><span class="p">[</span><span class="s1">&#39;object_type&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                  <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="n">omero_link</span><span class="p">})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[]</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">files</span></div>


<div class="viewcode-block" id="create_rspace_document_header">
<a class="viewcode-back" href="../../src.html#src.io_functions.create_rspace_document_header">[docs]</a>
<span class="k">def</span> <span class="nf">create_rspace_document_header</span><span class="p">(</span><span class="n">egroupware_project_name</span><span class="p">,</span> <span class="n">fs_storage_project_folder</span><span class="p">,</span> <span class="n">overlap_ratio</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a header for an RSpace document.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    egroupware_project_name (str): The name of the egroupware project.</span>
<span class="sd">    fs_storage_project_folder (str): The name of the fs_storage project folder.</span>
<span class="sd">    overlap_ratio (float): The overlap ratio.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;egroupware_project: </span><span class="si">{</span><span class="n">egroupware_project_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/p&gt;&quot;</span>
    <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;netstore_folder: </span><span class="si">{</span><span class="n">fs_storage_project_folder</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/p&gt;&quot;</span>
    <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;similarity ratio (egroupware_project; netstore_folder): </span><span class="si">{</span><span class="n">overlap_ratio</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/p&gt;&quot;</span>
    <span class="k">return</span> <span class="n">header</span></div>


<div class="viewcode-block" id="generate_html_table">
<a class="viewcode-back" href="../../src.html#src.io_functions.generate_html_table">[docs]</a>
<span class="k">def</span> <span class="nf">generate_html_table</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">get_placeholder_files_for_rspace</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function generates an HTML table.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    files (list): A list of files. Default is the output of get_placeholder_files_for_rspace().</span>
<span class="sd">    header (str): The header of the table. Default is an empty string.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The HTML table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table_html</span> <span class="o">=</span> <span class="s2">&quot;&lt;table style=&#39;border-collapse: collapse; width: 100%;&#39; border=&#39;1&#39; width=&#39;300&#39; cellpadding=&#39;5&#39;&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;  &lt;tbody&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;         &lt;th&gt;&lt;strong&gt;Omero Image Name&lt;/strong&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;         &lt;th&gt;&lt;strong&gt;File Type&lt;/strong&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;         &lt;th&gt;&lt;strong&gt;File Metadata&lt;/strong&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;         &lt;th&gt;&lt;strong&gt;Data Access&lt;/strong&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="n">file_type</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">file_metadata</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
        <span class="n">data_access</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;access&#39;</span><span class="p">]</span>

        <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      &lt;td&gt;&lt;a href=&#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&gt;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&lt;/a&gt;&lt;/td&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      &lt;td&gt;</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      &lt;td&gt;</span><span class="si">{</span><span class="n">file_metadata</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;      &lt;td&gt;&lt;a href=&#39;</span><span class="si">{</span><span class="n">data_access</span><span class="si">}</span><span class="s2">&#39;&gt;</span><span class="si">{</span><span class="n">data_access</span><span class="si">}</span><span class="s2">&lt;/a&gt;&lt;/td&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;  &lt;/tbody&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/table&gt;&quot;</span>

    <span class="k">if</span> <span class="n">header</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">table_html</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">table_html</span>

    <span class="k">return</span> <span class="n">table_html</span></div>


<span class="sd">&quot;&quot;&quot; ## TODO: untested function</span>
<span class="sd">    def get_egroupware_schedule_overlap(placeholder1, placeholder2):</span>
<span class="sd">            ## this part calc the overlap between schedule</span>
<span class="sd">            result = calculate_binary_overlap(egroupware_joined_df, </span>
<span class="sd">                                            &#39;start_timestamp_y&#39;, </span>
<span class="sd">                                            netstore_joined_df, </span>
<span class="sd">                                            &#39;created_timestamp_y&#39;, </span>
<span class="sd">                                            1)        </span>
<span class="sd">            for i, ns in enumerate(netstore_joined_df[&#39;fs_id&#39;]):                   </span>
<span class="sd">                if list(result.iloc[i])[0] == 0:                </span>
<span class="sd">                    continue            </span>
<span class="sd">                link = {&#39;src_id&#39;: project_id,</span>
<span class="sd">                                        &#39;src_table&#39;: &#39;project_registration&#39;,</span>
<span class="sd">                                        &#39;tar_id&#39;: object_id,</span>
<span class="sd">                                        &#39;tar_table&#39;: &#39;object&#39;, </span>
<span class="sd">                                        &#39;overlap_ratio&#39;: list(result.iloc[i])[0],</span>
<span class="sd">                                        &#39;manual_validated&#39;: 0,</span>
<span class="sd">                                        &#39;created_timestamp&#39;: datetime.datetime.now().strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
<span class="sd">                                        &#39;modified_timestamp&#39;: datetime.datetime.now().strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
<span class="sd">                                        &#39;notes&#39;: &quot;object[source == &#39;fs_storage&#39;]; get_col_overlap_df(netstore_joined_df.iloc[0:1], egroupware_joined_df.iloc[0:1], &#39;object_name_x&#39;, &#39;project_name&#39;)&quot;}  </span>
<span class="sd">                print(link)</span>
<span class="sd">                insert_dict_to_database(db_name, &#39;link&#39;, link)</span>
<span class="sd">            &quot;&quot;&quot;</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, saibotMagd.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>